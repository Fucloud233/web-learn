<!DOCTYPE html>
<head>
    <title>Onedrive Connection Test</title>
    <meta charset="utf-8">
    <meta lang="zh-cn">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="auth.js"></script>
    <script>
        function signInToOneDrive() {
            // 定义一个map用于存储进行验证的信息
            var appInfo = {
                // 客户端的id
                "clientId": "fe770e5b-cd99-4b04-818f-df663f07102b",
                // 重定向之后的页面 返回的信息会在后面以query追加
                "redirectUri": "http://localhost:9999/callback.html",
                // 申请的范围
                "scopes": "user.read files.read files.read.all sites.read.all",
                // 使用microsoft graph方法 来验证服务器
                "authServiceUri": "https://login.microsoftonline.com/common/oauth2/v2.0/authorize"
            }
            
            // 设置上述AppInfo
            setAppInfo(appInfo)
            // 进行验证
            authorize();
        }

        function signOut() {
            logoutOfAuth();

            location.reload();
        }
        
        function showCustomLoginButton(show) {
            var loginBtn = document.getElementById("login-div")
            loginBtn.style.display = show ? "block" : "none";

            var logoutBtn = document.getElementById("logout-div")
            logoutBtn.style.display = show ? "none" : "block";
        }

    </script>
</head>
<body>
    <div id="login-div">
        <a href="#" id="loginText" onclick="signInToOneDrive()">Sign in</a>
    </div>
    <div id="logout-div" style="display: none;">
        <a href="#" id="logoutText" onclick="signOut()">Sign out</a>
    </div>
    <div id="content-div">
        <div id="items-div"></div>
    </div>

    <script>
        function authenticated(token, authWindow) {
            if(!token) {
                alert("Error signing in");
                return;
            }

            // 对页面进行处理
            if(authWindow) {
                removeLoginButton();
                authWindow.close();
            }
            
            // todo 对ondrive进行操作
            // var getBtn = document.createElement("button")
            // getBtn.onclick = authenticated
            // getBtn.innerHTML("Get")

            var root = "https://graph.microsoft.com/v1.0/me/drive/root";
            // var path = ":/Temp/test.txt:";
            // var path = ":/Temp:/children";
            var path = "/children"
            var url = root + escape(path);

            // 使用ajax方法
            // https://www.geeksforgeeks.org/how-to-make-ajax-call-from-javascript/#
            
            $.ajax ({
                // 设置ajax申请方式
                url: url,
                type: "GET",
                dataType: 'json',
                headers: { "Authorization": "Bearer " + token },
                accept: "application/json;odata.metadata=none",
                success: function (data) {
                    if(data) {
                        console.log("ok")
                        
                        var children = data.children || data.value;
                        // 将children对象转换成列表
                        children = Object.values(children)
                        if(children && children.length > 0 ) {
                            // 创建用于存储文件路径的列表
                            var itemsList = document.createElement('ll')
                            itemsList.innerText = "文件目录:";
                            itemsList.id = "items-list";
                            document.getElementById("items-div").appendChild(itemsList);
                            
                            // 再将每个文件路径添加到上述链表
                            children.forEach(item => {
                                var itemText = document.createElement('li')
                                itemText.innerText = itemText.textContent = item.name;

                                // https://www.w3schools.com/jsref/met_node_appendchild.asp
                                document.getElementById("items-list").appendChild(itemText);
                            });
                        }
                    }
                },
                error: function(error) {
                    console.log(`Error ${error.responseText}`)
                }
            })
        }
    </script>
</body>